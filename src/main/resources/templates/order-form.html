<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Shto Porosi të Re</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <style>
        .searchable-select {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .searchable-select .select-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
        }
        .searchable-select .select-input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .searchable-select .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .searchable-select .dropdown-menu.show {
            display: block;
        }
        .searchable-select .dropdown-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .searchable-select .dropdown-item:hover {
            background-color: #f8f9fa;
        }
        .searchable-select .dropdown-item:last-child {
            border-bottom: none;
        }
        .searchable-select .no-results {
            padding: 10px;
            color: #999;
            font-style: italic;
        }

        .mb-3 .searchable-select {
            width: 100%;
        }

        .services-subtable {
            margin-top: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 10px;
        }
        .services-subtable table {
            font-size: 0.875rem;
        }
    </style>
</head>

<body>
<div class="container mt-4">
    <h1>Shto Porosi të Re</h1>

    <!-- Mesazhe error/success -->
    <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
    <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>

    <form th:action="@{/orders/add}" th:object="${orderCreateDTO}" method="post">

        <!-- ----------------- KLIENTI ----------------- -->
        <div class="mb-3">
            <label class="form-label">Klienti *</label>
            <div id="customerContainer" class="searchable-select">
                <input type="text" class="select-input"
                       placeholder="Shkruaj emrin e klientit..."
                       readonly/>
                <div class="dropdown-menu"></div>

                <!-- Lista e klientëve (origjinalet hiqen me JS, përdoren si template) -->
                <div class="dropdown-item"
                     th:each="customer : ${customers}"
                     th:data-value="${customer.id}"
                     th:text="${customer.firstName} + ' ' + ${customer.lastName}">
                </div>
            </div>
            <input type="hidden" th:field="*{customerId}"/>
            <div th:if="${#fields.hasErrors('customerId')}" class="text-danger" th:errors="*{customerId}"></div>
            <small class="form-text text-muted">Kliko dhe shkruaj për të kërkuar klientin nga lista.</small>
        </div>

        <!-- ----------------- DATAT DHE SHËNIMET ----------------- -->
        <div class="mb-3">
            <label class="form-label">Data e Dorëzimit *</label>
            <input type="date"
                   th:field="*{dropoffDate}"
                   class="form-control"
                   required
                   th:min="${#temporals.format(T(java.time.LocalDate).now(), 'yyyy-MM-dd')}"/>
            <div th:if="${#fields.hasErrors('dropoffDate')}" class="text-danger" th:errors="*{dropoffDate}"></div>
            <small class="form-text text-muted">Min: Sot ose më vonë.</small>
        </div>

        <div class="mb-3">
            <label class="form-label">Data e Marrjes</label>
            <input type="date"
                   th:field="*{pickupDate}"
                   class="form-control"
                   th:min="${#temporals.format(T(java.time.LocalDate).now(), 'yyyy-MM-dd')}"/>
            <div th:if="${#fields.hasErrors('pickupDate')}" class="text-danger" th:errors="*{pickupDate}"></div>
        </div>

        <div class="mb-3">
            <label class="form-label">Shënime</label>
            <textarea th:field="*{notes}" class="form-control" rows="3"></textarea>
            <div th:if="${#fields.hasErrors('notes')}" class="text-danger" th:errors="*{notes}"></div>
        </div>

        <!-- Status (mund ta mbash hidden, backend e vendos RECEIVED prapë) -->
        <input type="hidden" th:field="*{status}" value="RECEIVED"/>

        <!-- ----------------- ITEMS (RROBAT) ----------------- -->
        <h3>Artikujt e Porosisë (Rrobat)</h3>
        <p>Shto artikujt që do të lahen. Subtotal-i dhe totali llogariten automatikisht.</p>

        <div class="mb-3">
            <button type="button" class="btn btn-success mb-2" onclick="addItemRow()">Shto Artikull</button>

            <table class="table table-bordered">
                <thead>
                <tr>
                    <th>Përshkrimi</th>
                    <th>Sasia</th>
                    <th>Çmimi Unitar (€)</th>
                    <th>Veprime Item</th>
                    <th>Shërbimet për këtë Item</th>
                </tr>
                </thead>
                <tbody id="itemsTableBody">

                <!-- Nëse ka items nga DTO (p.sh. nga validation error) -->
                <tr th:each="item, iterStat : *{orderItems}"
                    th:attr="data-item-index=${iterStat.index}">
                    <td>
                        <input type="text"
                               th:field="*{orderItems[__${iterStat.index}__].itemDescription}"
                               class="form-control" required/>
                    </td>
                    <td>
                        <input type="number"
                               th:field="*{orderItems[__${iterStat.index}__].quantity}"
                               class="form-control" min="1" required/>
                    </td>
                    <td>
                        <input type="number" step="0.01"
                               th:field="*{orderItems[__${iterStat.index}__].unitPrice}"
                               class="form-control" min="0" required/>
                    </td>
                    <td>
                        <button type="button" class="btn btn-success btn-sm me-1" onclick="addServiceRow(this)">
                            Shto Shërbim
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteItemRow(this)">
                            Fshij Item
                        </button>
                    </td>
                    <td>
                        <div class="services-subtable">
                            <table class="table table-sm table-bordered">
                                <thead>
                                <tr>
                                    <th>Shërbim</th>
                                    <th>Sasia</th>
                                    <th>Çmim (€)</th>
                                    <th>Veprime</th>
                                </tr>
                                </thead>
                                <tbody th:id="'servicesBody_' + ${iterStat.index}">

                                <!-- Services ekzistuese për këtë item -->
                                <tr th:each="oservice, sIter : *{orderServices}"
                                    th:if="${oservice.orderItemId} == ${iterStat.index}">
                                    <td>
                                        <div th:id="'serviceContainer_' + ${sIter.index}" class="searchable-select">
                                            <input type="text"
                                                   class="select-input"
                                                   th:value="${oservice.serviceName != null} ? ${oservice.serviceName} : ''"
                                                   placeholder="Zgjidh shërbimin..."
                                                   readonly/>
                                            <div class="dropdown-menu"></div>
                                        </div>

                                        <!-- serviceId -->
                                        <input type="hidden"
                                               th:name="'orderServices[' + ${sIter.index} + '].serviceId'"
                                               th:value="${oservice.serviceId}"/>

                                        <!-- orderItemId (këtu po ruajmë index-in e item-it) -->
                                        <input type="hidden"
                                               th:name="'orderServices[' + ${sIter.index} + '].orderItemId'"
                                               th:value="${iterStat.index}"/>
                                    </td>
                                    <td>
                                        <input type="number"
                                               th:name="'orderServices[' + ${sIter.index} + '].quantity'"
                                               th:value="${oservice.quantity}"
                                               class="form-control form-control-sm"
                                               min="1" required/>
                                    </td>
                                    <td>
                                        <input type="number" step="0.01"
                                               th:name="'orderServices[' + ${sIter.index} + '].price'"
                                               th:value="${oservice.price}"
                                               class="form-control form-control-sm"
                                               min="0" readonly/>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-danger btn-sm"
                                                onclick="deleteServiceRow(this)">Fshij
                                        </button>
                                    </td>
                                </tr>

                                </tbody>
                            </table>
                        </div>
                    </td>
                </tr>

                <!-- Nëse nuk ka fare items në DTO, fus një rresht bosh default -->
                <tr th:if="${orderCreateDTO.orderItems == null or orderCreateDTO.orderItems.isEmpty()}"
                    data-item-index="0">
                    <td>
                        <input type="text"
                               name="orderItems[0].itemDescription"
                               class="form-control"
                               placeholder="P.sh., Këmishë e bardhë"
                               required/>
                    </td>
                    <td>
                        <input type="number"
                               name="orderItems[0].quantity"
                               class="form-control"
                               min="1" value="1" required/>
                    </td>
                    <td>
                        <input type="number" step="0.01"
                               name="orderItems[0].unitPrice"
                               class="form-control"
                               min="0" placeholder="P.sh., 5.00" required/>
                    </td>
                    <td>
                        <button type="button" class="btn btn-success btn-sm me-1" onclick="addServiceRow(this)">
                            Shto Shërbim
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteItemRow(this)">
                            Fshij Item
                        </button>
                    </td>
                    <td>
                        <div class="services-subtable">
                            <table class="table table-sm table-bordered">
                                <thead>
                                <tr>
                                    <th>Shërbim</th>
                                    <th>Sasia</th>
                                    <th>Çmim (€)</th>
                                    <th>Veprime</th>
                                </tr>
                                </thead>
                                <tbody id="servicesBody_0">
                                <!-- bosh fillimisht -->
                                </tbody>
                            </table>
                        </div>
                    </td>
                </tr>

                </tbody>
            </table>
        </div>

        <!-- ----------------- PAGESA ----------------- -->
        <div class="mb-3">
            <label class="form-label">Mënyra e Pagesës *</label>
            <select class="form-select" th:field="*{paymentMethod}" required>
                <option value="" disabled
                        th:selected="${orderCreateDTO.paymentMethod == null}">
                    Zgjidh mënyrën e pagesës
                </option>
                <option value="CASH">Cash</option>
                <option value="CARD">Kartë</option>
            </select>

            <div th:if="${#fields.hasErrors('paymentMethod')}"
                 class="text-danger"
                 th:errors="*{paymentMethod}">
            </div>
        </div>

        <!-- ----------------- TOTALI PARAPRAK ----------------- -->
        <div class="mb-3">
            <label class="form-label">Totali i Paraprirë (€)</label>
            <input type="text" id="totalAmount" class="form-control" readonly value="0.00"/>
            <small class="form-text text-muted">
                Llogaritet automatikisht (items + services). Totali zyrtar llogaritet në backend.
            </small>
        </div>

        <button type="submit" class="btn btn-primary">Ruaj Porosinë</button>
        <a th:href="@{/orders}" class="btn btn-secondary">Kthehu</a>
    </form>
</div>

<!-- Template i fshehur me të gjitha services nga DB (përdoret nga JS për çdo dropdown) -->
<div id="serviceDropdownTemplate" class="d-none">
    <div class="dropdown-item"
         th:each="service : ${services}"
         th:data-value="${service.id}"
         th:data-price="${service.pricePerUnit}"
         th:text="${service.name} + ' (' + ${service.pricePerUnit} + ' €)'">
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    // ----------------------------------------------------------------
    // COUNTERS
    // ----------------------------------------------------------------
    let itemCounter = /*[[${initialItemCount}]]*/ 0;
    let serviceCounter = /*[[${initialServiceCount}]]*/ 0;

    // ----------------------------------------------------------------
    // DYNAMIC ITEMS
    // ----------------------------------------------------------------
    function addItemRow() {
        const tableBody = document.getElementById('itemsTableBody');
        const existingRows = tableBody.querySelectorAll('tr');
        // index i ri për item-in
        itemCounter = existingRows.length > 0
            ? Math.max(...Array.from(existingRows).map(r => parseInt(r.dataset.itemIndex || "0"))) + 1
            : 0;

        const newRow = tableBody.insertRow();
        newRow.setAttribute('data-item-index', itemCounter);

        newRow.innerHTML = `
            <td>
                <input type="text"
                       name="orderItems[${itemCounter}].itemDescription"
                       class="form-control"
                       placeholder="P.sh., Këmishë e bardhë"
                       required/>
            </td>
            <td>
                <input type="number"
                       name="orderItems[${itemCounter}].quantity"
                       class="form-control"
                       min="1" value="1" required/>
            </td>
            <td>
                <input type="number" step="0.01"
                       name="orderItems[${itemCounter}].unitPrice"
                       class="form-control"
                       min="0" placeholder="P.sh., 5.00"
                       required/>
            </td>
            <td>
                <button type="button" class="btn btn-success btn-sm me-1" onclick="addServiceRow(this)">
                    Shto Shërbim
                </button>
                <button type="button" class="btn btn-danger btn-sm" onclick="deleteItemRow(this)">
                    Fshij Item
                </button>
            </td>
            <td>
                <div class="services-subtable">
                    <table class="table table-sm table-bordered">
                        <thead>
                        <tr>
                            <th>Shërbim</th>
                            <th>Sasia</th>
                            <th>Çmim (€)</th>
                            <th>Veprime</th>
                        </tr>
                        </thead>
                        <tbody id="servicesBody_${itemCounter}">
                        </tbody>
                    </table>
                </div>
            </td>
        `;

        // lidh eventet për total
        newRow.querySelectorAll('input[name$=".quantity"], input[name$=".unitPrice"]').forEach(input => {
            input.addEventListener('input', calculateTotal);
        });

        calculateTotal();
    }

    function deleteItemRow(button) {
        const row = button.closest('tr');
        if (!row) return;
        row.remove();
        calculateTotal();
    }

    // ----------------------------------------------------------------
    // DYNAMIC SERVICES PER ITEM
    // ----------------------------------------------------------------
    function addServiceRow(itemButton) {
        const itemRow = itemButton.closest('tr');
        if (!itemRow) return;

        const itemIndex = parseInt(itemRow.dataset.itemIndex || "0");
        const servicesBody = itemRow.querySelector(`#servicesBody_${itemIndex}`);
        if (!servicesBody) return;

        serviceCounter++;

        const newServiceRow = servicesBody.insertRow();

        newServiceRow.innerHTML = `
            <td>
                <div id="serviceContainer_${serviceCounter}" class="searchable-select">
                    <input type="text"
                           class="select-input"
                           placeholder="Zgjidh shërbimin..."
                           readonly/>
                    <div class="dropdown-menu"></div>
                </div>
                <input type="hidden" name="orderServices[${serviceCounter}].serviceId" value=""/>
            </td>
            <td>
                <input type="number"
                       name="orderServices[${serviceCounter}].quantity"
                       class="form-control form-control-sm"
                       min="1" value="1" required/>
            </td>
            <td>
                <input type="number" step="0.01"
                       name="orderServices[${serviceCounter}].price"
                       class="form-control form-control-sm"
                       min="0"
                       placeholder="Auto-llogaritet"
                       readonly/>
            </td>
            <td>
                <button type="button"
                        class="btn btn-danger btn-sm"
                        onclick="deleteServiceRow(this)">Fshij</button>
            </td>
        `;

        // hidden orderItemId (këtu po ruajmë index-in e item-it)
        const hiddenItemId = document.createElement('input');
        hiddenItemId.type = 'hidden';
        hiddenItemId.name = `orderServices[${serviceCounter}].orderItemId`;
        hiddenItemId.value = itemIndex;
        newServiceRow.appendChild(hiddenItemId);

        // events për total
        newServiceRow.querySelectorAll('input[name$=".quantity"]').forEach(input => {
            input.addEventListener('input', calculateTotal);
        });

        // inicializo search dropdown për këtë service
        initSearchableSelectForServices(`serviceContainer_${serviceCounter}`, `orderServices[${serviceCounter}].serviceId`);

        calculateTotal();
    }

    function deleteServiceRow(button) {
        const row = button.closest('tr');
        if (!row) return;
        row.remove();
        calculateTotal();
    }

    // ----------------------------------------------------------------
    // TOTALI
    // ----------------------------------------------------------------
    function calculateTotal() {
        let total = 0;

        // items bazë
        document.querySelectorAll('#itemsTableBody tr').forEach(row => {
            const qtyInput = row.querySelector('input[name$=".quantity"]');
            const priceInput = row.querySelector('input[name$=".unitPrice"]');
            if (qtyInput && priceInput) {
                const qty = parseInt(qtyInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                total += qty * price;
            }
        });

        // services
        document.querySelectorAll('.services-subtable tbody tr').forEach(row => {
            const qtyInput = row.querySelector('input[name$=".quantity"]');
            const priceInput = row.querySelector('input[name$=".price"]');
            if (qtyInput && priceInput) {
                const qty = parseInt(qtyInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                total += qty * price;
            }
        });

        const totalField = document.getElementById('totalAmount');
        if (totalField) {
            totalField.value = total.toFixed(2) + ' €';
        }
    }

    // ----------------------------------------------------------------
    // SEARCHABLE SELECT - SERVICES
    // ----------------------------------------------------------------
    function initSearchableSelectForServices(containerId, hiddenFieldName) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const input = container.querySelector('.select-input');
        const dropdown = container.querySelector('.dropdown-menu');
        if (!input || !dropdown) return;

        const templateItems = Array.from(document.querySelectorAll('#serviceDropdownTemplate .dropdown-item'));
        let items = templateItems.map(item => item.cloneNode(true));

        function renderItems(list) {
            dropdown.innerHTML = '';
            if (!list || list.length === 0) {
                dropdown.innerHTML = '<div class="no-results">Asnjë shërbim nuk u gjet.</div>';
                return;
            }
            list.forEach(i => dropdown.appendChild(i));
        }

        function filterItems(query) {
            if (!query) {
                renderItems(items.map(i => i.cloneNode(true)));
            } else {
                const filtered = items.filter(i =>
                    i.textContent.toLowerCase().includes(query.toLowerCase())
                );
                renderItems(filtered.map(i => i.cloneNode(true)));
            }
        }

        input.addEventListener('click', function (e) {
            e.stopPropagation();
            input.removeAttribute('readonly');
            filterItems(input.value);
            dropdown.classList.add('show');
            input.focus();
        });

        input.addEventListener('input', function () {
            filterItems(input.value);
            dropdown.classList.add('show');
        });

        dropdown.addEventListener('click', function (e) {
            const target = e.target.closest('.dropdown-item');
            if (!target) return;

            input.value = target.textContent.trim();

            const hiddenInput = document.querySelector(`input[name="${hiddenFieldName}"]`);
            if (hiddenInput) {
                hiddenInput.value = target.dataset.value;
            }

            // vendos price automatik
            const priceInput = container.closest('tr').querySelector('input[name$=".price"]');
            if (priceInput && target.dataset.price) {
                priceInput.value = target.dataset.price;
            }

            dropdown.classList.remove('show');
            calculateTotal();
        });

        document.addEventListener('click', function (e) {
            if (!container.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        dropdown.classList.remove('show');
    }

    // ----------------------------------------------------------------
    // SEARCHABLE SELECT - KLIENTËT
    // ----------------------------------------------------------------
    function initSearchableSelectForCustomers() {
        const container = document.getElementById('customerContainer');
        if (!container) return;

        const input = container.querySelector('.select-input');
        const dropdown = container.querySelector('.dropdown-menu');
        let items = Array.from(container.querySelectorAll('.dropdown-item'));

        // hiq origjinalet nga DOM, ruaji në memorie
        items.forEach(item => item.remove());

        function renderItems(list) {
            dropdown.innerHTML = '';
            if (!list || list.length === 0) {
                dropdown.innerHTML = '<div class="no-results">Asnjë klient nuk u gjet.</div>';
                return;
            }
            list.forEach(i => dropdown.appendChild(i));
        }

        function filterItems(query) {
            if (!query) {
                const unique = [...new Set(items.map(i => i.textContent.trim()))]
                    .map(text => items.find(i => i.textContent.trim() === text).cloneNode(true));
                renderItems(unique);
            } else {
                const filtered = items.filter(i =>
                    i.textContent.toLowerCase().includes(query.toLowerCase())
                );
                const uniqueFiltered = [...new Set(filtered.map(i => i.textContent.trim()))]
                    .map(text => filtered.find(i => i.textContent.trim() === text).cloneNode(true));
                renderItems(uniqueFiltered);
            }
        }

        input.addEventListener('click', function (e) {
            e.stopPropagation();
            input.removeAttribute('readonly');
            filterItems(input.value);
            dropdown.classList.add('show');
            input.focus();
        });

        input.addEventListener('input', function () {
            filterItems(input.value);
            dropdown.classList.add('show');
        });

        dropdown.addEventListener('click', function (e) {
            const target = e.target.closest('.dropdown-item');
            if (!target) return;

            input.value = target.textContent.trim();
            const hiddenInput = document.querySelector('input[name="customerId"]');
            if (hiddenInput) {
                hiddenInput.value = target.dataset.value;
            }
            dropdown.classList.remove('show');
        });

        document.addEventListener('click', function (e) {
            if (!container.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        dropdown.classList.remove('show');
    }

    // ----------------------------------------------------------------
    // ON LOAD
    // ----------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', function () {

        // Inicializo totalet
        calculateTotal();

        // Lidh evente ekzistuese për input-et
        document.querySelectorAll('input[name$=".quantity"], input[name$=".unitPrice"], input[name$=".price"]')
            .forEach(input => {
                input.addEventListener('input', calculateTotal);
            });

        // Klientët searchable
        initSearchableSelectForCustomers();

        // Services ekzistuese nëse ka (nga DTO pas error-it)
        document.querySelectorAll('.services-subtable tbody tr .searchable-select')
            .forEach((selectContainer, index) => {
                if (!selectContainer.id) {
                    selectContainer.id = `serviceContainer_${index}`;
                }
                initSearchableSelectForServices(selectContainer.id, `orderServices[${index}].serviceId`);
            });
    });
</script>
</body>
</html>

