
<!--<!DOCTYPE html>-->
<!--<html xmlns:th="http://www.thymeleaf.org">-->
<!--<head>-->
<!--    <title>Shto Porosi tÃ« Re</title>-->
<!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>-->

<!--    <style>-->
<!--        .searchable-select {-->
<!--            position: relative;-->
<!--            display: inline-block;-->
<!--            width: 100%;-->
<!--        }-->
<!--        .searchable-select .select-input {-->
<!--            width: 100%;-->
<!--            padding: 10px;-->
<!--            border: 1px solid #ddd;-->
<!--            border-radius: 4px;-->
<!--            background: white;-->
<!--            cursor: pointer;-->
<!--        }-->
<!--        .searchable-select .select-input:focus {-->
<!--            outline: none;-->
<!--            border-color: #4CAF50;-->
<!--        }-->
<!--        .searchable-select .dropdown-menu {-->
<!--            position: absolute;-->
<!--            top: 100%;-->
<!--            left: 0;-->
<!--            right: 0;-->
<!--            max-height: 200px;-->
<!--            overflow-y: auto;-->
<!--            background: white;-->
<!--            border: 1px solid #ddd;-->
<!--            border-top: none;-->
<!--            border-radius: 0 0 4px 4px;-->
<!--            z-index: 1000;-->
<!--            display: none;-->
<!--            box-shadow: 0 2px 10px rgba(0,0,0,0.1);-->
<!--        }-->
<!--        .searchable-select .dropdown-menu.show {-->
<!--            display: block;-->
<!--        }-->
<!--        .searchable-select .dropdown-item {-->
<!--            padding: 10px;-->
<!--            cursor: pointer;-->
<!--            border-bottom: 1px solid #eee;-->
<!--        }-->
<!--        .searchable-select .dropdown-item:hover {-->
<!--            background-color: #f8f9fa;-->
<!--        }-->
<!--        .searchable-select .dropdown-item:last-child {-->
<!--            border-bottom: none;-->
<!--        }-->
<!--        .searchable-select .no-results {-->
<!--            padding: 10px;-->
<!--            color: #999;-->
<!--            font-style: italic;-->
<!--        }-->

<!--        .mb-3 .searchable-select {-->
<!--            width: 100%;-->
<!--        }-->

<!--        .services-subtable {-->
<!--            margin-top: 10px;-->
<!--            background-color: #f8f9fa;-->
<!--            border-radius: 4px;-->
<!--            padding: 10px;-->
<!--        }-->
<!--        .services-subtable table {-->
<!--            font-size: 0.875rem;-->
<!--        }-->
<!--    </style>-->
<!--</head>-->

<!--<body>-->
<!--<div class="container mt-4">-->
<!--    <h1>Shto Porosi tÃ« Re</h1>-->

<!--    &lt;!&ndash; Mesazhe error/success &ndash;&gt;-->
<!--    <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>-->
<!--    <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>-->

<!--    <form th:action="@{/orders/add}" th:object="${orderCreateDTO}" method="post">-->

<!--        &lt;!&ndash; -&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45; KLIENTI -&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45; &ndash;&gt;-->
<!--        <div class="mb-3">-->
<!--            <label class="form-label">Klienti *</label>-->
<!--            <div id="customerContainer" class="searchable-select">-->
<!--                <input type="text" class="select-input"-->
<!--                       placeholder="Shkruaj emrin e klientit..."-->
<!--                       readonly/>-->
<!--                <div class="dropdown-menu"></div>-->

<!--                &lt;!&ndash; Lista e klientÃ«ve (origjinalet hiqen me JS, pÃ«rdoren si template) &ndash;&gt;-->
<!--                <div class="dropdown-item"-->
<!--                     th:each="customer : ${customers}"-->
<!--                     th:data-value="${customer.id}"-->
<!--                     th:text="${customer.firstName} + ' ' + ${customer.lastName}">-->
<!--                </div>-->
<!--            </div>-->
<!--            <input type="hidden" th:field="*{customerId}"/>-->
<!--            <div th:if="${#fields.hasErrors('customerId')}" class="text-danger" th:errors="*{customerId}"></div>-->
<!--            <small class="form-text text-muted">Kliko dhe shkruaj pÃ«r tÃ« kÃ«rkuar klientin nga lista.</small>-->
<!--        </div>-->

<!--        &lt;!&ndash; ðŸ”¹ PUNÃ‹TORI (EMPLOYEE) â€“ ADDED BLOCK &ndash;&gt;-->
<!--&lt;!&ndash;        <div class="mb-3">&ndash;&gt;-->
<!--&lt;!&ndash;            <label class="form-label">PunÃ«tori *</label>&ndash;&gt;-->
<!--&lt;!&ndash;            <select class="form-select" th:field="*{employeeId}">&ndash;&gt;-->
<!--&lt;!&ndash;                <option value="">Zgjidh punÃ«torin</option>&ndash;&gt;-->
<!--&lt;!&ndash;                <option th:each="emp : ${employees}"&ndash;&gt;-->
<!--&lt;!&ndash;                        th:value="${emp.id}"&ndash;&gt;-->
<!--&lt;!&ndash;                        th:text="${emp.firstName} + ' ' + ${emp.lastName}">&ndash;&gt;-->
<!--&lt;!&ndash;                </option>&ndash;&gt;-->
<!--&lt;!&ndash;            </select>&ndash;&gt;-->
<!--&lt;!&ndash;            <div th:if="${#fields.hasErrors('employeeId')}"&ndash;&gt;-->
<!--&lt;!&ndash;                 class="text-danger"&ndash;&gt;-->
<!--&lt;!&ndash;                 th:errors="*{employeeId}"></div>&ndash;&gt;-->
<!--&lt;!&ndash;        </div>&ndash;&gt;-->
<!--        &lt;!&ndash; ðŸ”¹ END EMPLOYEE BLOCK &ndash;&gt;-->

<!--        &lt;!&ndash; -&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45; DATAT DHE SHÃ‹NIMET -&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45; &ndash;&gt;-->
<!--        <div class="mb-3">-->
<!--            <label class="form-label">Data e DorÃ«zimit *</label>-->
<!--            <input type="date"-->
<!--                   th:field="*{dropoffDate}"-->
<!--                   class="form-control"-->
<!--                   required-->
<!--                   th:min="${#temporals.format(T(java.time.LocalDate).now(), 'yyyy-MM-dd')}"/>-->
<!--            <div th:if="${#fields.hasErrors('dropoffDate')}" class="text-danger" th:errors="*{dropoffDate}"></div>-->
<!--            <small class="form-text text-muted">Min: Sot ose mÃ« vonÃ«.</small>-->
<!--        </div>-->

<!--        <div class="mb-3">-->
<!--            <label class="form-label">Data e Marrjes</label>-->
<!--            <input type="date"-->
<!--                   th:field="*{pickupDate}"-->
<!--                   class="form-control"-->
<!--                   th:min="${#temporals.format(T(java.time.LocalDate).now(), 'yyyy-MM-dd')}"/>-->
<!--            <div th:if="${#fields.hasErrors('pickupDate')}" class="text-danger" th:errors="*{pickupDate}"></div>-->
<!--        </div>-->

<!--        <div class="mb-3">-->
<!--            <label class="form-label">ShÃ«nime</label>-->
<!--            <textarea th:field="*{notes}" class="form-control" rows="3"></textarea>-->
<!--            <div th:if="${#fields.hasErrors('notes')}" class="text-danger" th:errors="*{notes}"></div>-->
<!--        </div>-->

<!--        &lt;!&ndash; Status (mund ta mbash hidden, backend e vendos RECEIVED prapÃ«) &ndash;&gt;-->
<!--        <input type="hidden" th:field="*{status}" value="RECEIVED"/>-->

<!--        &lt;!&ndash; -&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45; ITEMS (RROBAT) -&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45; &ndash;&gt;-->
<!--        <h3>Artikujt e PorosisÃ« (Rrobat)</h3>-->
<!--        <p>Shto artikujt qÃ« do tÃ« lahen. Subtotal-i dhe totali llogariten automatikisht.</p>-->

<!--        <div class="mb-3">-->
<!--            <button type="button" class="btn btn-success mb-2" onclick="addItemRow()">Shto Artikull</button>-->

<!--            <table class="table table-bordered">-->
<!--                <thead>-->
<!--                <tr>-->
<!--                    <th>PÃ«rshkrimi</th>-->
<!--                    <th>Sasia</th>-->
<!--                    <th>Ã‡mimi Unitar (â‚¬)</th>-->
<!--                    <th>Veprime Item</th>-->
<!--                    <th>ShÃ«rbimet pÃ«r kÃ«tÃ« Item</th>-->
<!--                </tr>-->
<!--                </thead>-->
<!--                <tbody id="itemsTableBody">-->

<!--                &lt;!&ndash; NÃ«se ka items nga DTO (p.sh. nga validation error) &ndash;&gt;-->
<!--                <tr th:each="item, iterStat : *{orderItems}"-->
<!--                    th:attr="data-item-index=${iterStat.index}">-->
<!--                    <td>-->
<!--                        <input type="text"-->
<!--                               th:field="*{orderItems[__${iterStat.index}__].itemDescription}"-->
<!--                               class="form-control" required/>-->
<!--                    </td>-->
<!--                    <td>-->
<!--                        <input type="number"-->
<!--                               th:field="*{orderItems[__${iterStat.index}__].quantity}"-->
<!--                               class="form-control" min="1" required/>-->
<!--                    </td>-->
<!--                    <td>-->
<!--                        <input type="number" step="0.01"-->
<!--                               th:field="*{orderItems[__${iterStat.index}__].unitPrice}"-->
<!--                               class="form-control" min="0" required/>-->
<!--                    </td>-->
<!--                    <td>-->
<!--                        <button type="button" class="btn btn-success btn-sm me-1" onclick="addServiceRow(this)">-->
<!--                            Shto ShÃ«rbim-->
<!--                        </button>-->
<!--                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteItemRow(this)">-->
<!--                            Fshij Item-->
<!--                        </button>-->
<!--                    </td>-->
<!--                    <td>-->
<!--                        <div class="services-subtable">-->
<!--                            <table class="table table-sm table-bordered">-->
<!--                                <thead>-->
<!--                                <tr>-->
<!--                                    <th>ShÃ«rbim</th>-->
<!--                                    <th>Sasia</th>-->
<!--                                    <th>Ã‡mim (â‚¬)</th>-->
<!--                                    <th>Veprime</th>-->
<!--                                </tr>-->
<!--                                </thead>-->
<!--                                <tbody th:id="'servicesBody_' + ${iterStat.index}">-->

<!--                                &lt;!&ndash; Services ekzistuese pÃ«r kÃ«tÃ« item &ndash;&gt;-->
<!--                                <tr th:each="oservice, sIter : *{orderServices}"-->
<!--                                    th:if="${oservice.orderItemId} == ${iterStat.index}">-->
<!--                                    <td>-->
<!--                                        <div th:id="'serviceContainer_' + ${sIter.index}" class="searchable-select">-->
<!--                                            <input type="text"-->
<!--                                                   class="select-input"-->
<!--                                                   th:value="${oservice.serviceName != null} ? ${oservice.serviceName} : ''"-->
<!--                                                   placeholder="Zgjidh shÃ«rbimin..."-->
<!--                                                   readonly/>-->
<!--                                            <div class="dropdown-menu"></div>-->
<!--                                        </div>-->

<!--                                        &lt;!&ndash; serviceId &ndash;&gt;-->
<!--                                        <input type="hidden"-->
<!--                                               th:name="'orderServices[' + ${sIter.index} + '].serviceId'"-->
<!--                                               th:value="${oservice.serviceId}"/>-->

<!--                                        &lt;!&ndash; orderItemId (kÃ«tu po ruajmÃ« index-in e item-it) &ndash;&gt;-->
<!--                                        <input type="hidden"-->
<!--                                               th:name="'orderServices[' + ${sIter.index} + '].orderItemId'"-->
<!--                                               th:value="${iterStat.index}"/>-->
<!--                                    </td>-->
<!--                                    <td>-->
<!--                                        <input type="number"-->
<!--                                               th:name="'orderServices[' + ${sIter.index} + '].quantity'"-->
<!--                                               th:value="${oservice.quantity}"-->
<!--                                               class="form-control form-control-sm"-->
<!--                                               min="1" required/>-->
<!--                                    </td>-->
<!--                                    <td>-->
<!--                                        <input type="number" step="0.01"-->
<!--                                               th:name="'orderServices[' + ${sIter.index} + '].price'"-->
<!--                                               th:value="${oservice.price}"-->
<!--                                               class="form-control form-control-sm"-->
<!--                                               min="0" readonly/>-->
<!--                                    </td>-->
<!--                                    <td>-->
<!--                                        <button type="button" class="btn btn-danger btn-sm"-->
<!--                                                onclick="deleteServiceRow(this)">Fshij-->
<!--                                        </button>-->
<!--                                    </td>-->
<!--                                </tr>-->

<!--                                </tbody>-->
<!--                            </table>-->
<!--                        </div>-->
<!--                    </td>-->
<!--                </tr>-->

<!--                &lt;!&ndash; NÃ«se nuk ka fare items nÃ« DTO, fus njÃ« rresht bosh default &ndash;&gt;-->
<!--                <tr th:if="${orderCreateDTO.orderItems == null or orderCreateDTO.orderItems.isEmpty()}"-->
<!--                    data-item-index="0">-->
<!--                    <td>-->
<!--                        <input type="text"-->
<!--                               name="orderItems[0].itemDescription"-->
<!--                               class="form-control"-->
<!--                               placeholder="P.sh., KÃ«mishÃ« e bardhÃ«"-->
<!--                               required/>-->
<!--                    </td>-->
<!--                    <td>-->
<!--                        <input type="number"-->
<!--                               name="orderItems[0].quantity"-->
<!--                               class="form-control"-->
<!--                               min="1" value="1" required/>-->
<!--                    </td>-->
<!--                    <td>-->
<!--                        <input type="number" step="0.01"-->
<!--                               name="orderItems[0].unitPrice"-->
<!--                               class="form-control"-->
<!--                               min="0" placeholder="P.sh., 5.00" required/>-->
<!--                    </td>-->
<!--                    <td>-->
<!--                        <button type="button" class="btn btn-success btn-sm me-1" onclick="addServiceRow(this)">-->
<!--                            Shto ShÃ«rbim-->
<!--                        </button>-->
<!--                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteItemRow(this)">-->
<!--                            Fshij Item-->
<!--                        </button>-->
<!--                    </td>-->
<!--                    <td>-->
<!--                        <div class="services-subtable">-->
<!--                            <table class="table table-sm table-bordered">-->
<!--                                <thead>-->
<!--                                <tr>-->
<!--                                    <th>ShÃ«rbim</th>-->
<!--                                    <th>Sasia</th>-->
<!--                                    <th>Ã‡mim (â‚¬)</th>-->
<!--                                    <th>Veprime</th>-->
<!--                                </tr>-->
<!--                                </thead>-->
<!--                                <tbody id="servicesBody_0">-->
<!--                                &lt;!&ndash; bosh fillimisht &ndash;&gt;-->
<!--                                </tbody>-->
<!--                            </table>-->
<!--                        </div>-->
<!--                    </td>-->
<!--                </tr>-->

<!--                </tbody>-->
<!--            </table>-->
<!--        </div>-->

<!--        &lt;!&ndash; -&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45; TOTALI PARAPRAK -&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45; &ndash;&gt;-->
<!--        <div class="mb-3">-->
<!--            <label class="form-label">Totali i ParaprirÃ« (â‚¬)</label>-->
<!--            <input type="text" id="totalAmount" class="form-control" readonly value="0.00"/>-->
<!--            <small class="form-text text-muted">-->
<!--                Llogaritet automatikisht (items + services). Totali zyrtar llogaritet nÃ« backend.-->
<!--            </small>-->
<!--        </div>-->

<!--        <button type="submit" class="btn btn-primary">Ruaj PorosinÃ«</button>-->
<!--        <a th:href="@{/orders}" class="btn btn-secondary">Kthehu</a>-->
<!--    </form>-->
<!--</div>-->

<!--&lt;!&ndash; Template i fshehur me tÃ« gjitha services nga DB (pÃ«rdoret nga JS pÃ«r Ã§do dropdown) &ndash;&gt;-->
<!--<div id="serviceDropdownTemplate" class="d-none">-->
<!--    <div class="dropdown-item"-->
<!--         th:each="service : ${services}"-->
<!--         th:data-value="${service.id}"-->
<!--         th:data-price="${service.pricePerUnit}"-->
<!--         th:text="${service.name} + ' (' + ${service.pricePerUnit} + ' â‚¬)'">-->
<!--    </div>-->
<!--</div>-->

<!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>-->

<!--<script th:inline="javascript">-->
<!--    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
<!--    // COUNTERS-->
<!--    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
<!--    let itemCounter = /*[[${initialItemCount}]]*/ 0;-->
<!--    let serviceCounter = /*[[${initialServiceCount}]]*/ 0;-->

<!--    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
<!--    // DYNAMIC ITEMS-->
<!--    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
<!--    function addItemRow() {-->
<!--        const tableBody = document.getElementById('itemsTableBody');-->
<!--        const existingRows = tableBody.querySelectorAll('tr');-->
<!--        // index i ri pÃ«r item-in-->
<!--        itemCounter = existingRows.length > 0-->
<!--            ? Math.max(...Array.from(existingRows).map(r => parseInt(r.dataset.itemIndex || "0"))) + 1-->
<!--            : 0;-->

<!--        const newRow = tableBody.insertRow();-->
<!--        newRow.setAttribute('data-item-index', itemCounter);-->

<!--        newRow.innerHTML = `-->
<!--            <td>-->
<!--                <input type="text"-->
<!--                       name="orderItems[${itemCounter}].itemDescription"-->
<!--                       class="form-control"-->
<!--                       placeholder="P.sh., KÃ«mishÃ« e bardhÃ«"-->
<!--                       required/>-->
<!--            </td>-->
<!--            <td>-->
<!--                <input type="number"-->
<!--                       name="orderItems[${itemCounter}].quantity"-->
<!--                       class="form-control"-->
<!--                       min="1" value="1" required/>-->
<!--            </td>-->
<!--            <td>-->
<!--                <input type="number" step="0.01"-->
<!--                       name="orderItems[${itemCounter}].unitPrice"-->
<!--                       class="form-control"-->
<!--                       min="0" placeholder="P.sh., 5.00"-->
<!--                       required/>-->
<!--            </td>-->
<!--            <td>-->
<!--                <button type="button" class="btn btn-success btn-sm me-1" onclick="addServiceRow(this)">-->
<!--                    Shto ShÃ«rbim-->
<!--                </button>-->
<!--                <button type="button" class="btn btn-danger btn-sm" onclick="deleteItemRow(this)">-->
<!--                    Fshij Item-->
<!--                </button>-->
<!--            </td>-->
<!--            <td>-->
<!--                <div class="services-subtable">-->
<!--                    <table class="table table-sm table-bordered">-->
<!--                        <thead>-->
<!--                        <tr>-->
<!--                            <th>ShÃ«rbim</th>-->
<!--                            <th>Sasia</th>-->
<!--                            <th>Ã‡mim (â‚¬)</th>-->
<!--                            <th>Veprime</th>-->
<!--                        </tr>-->
<!--                        </thead>-->
<!--                        <tbody id="servicesBody_${itemCounter}">-->
<!--                        </tbody>-->
<!--                    </table>-->
<!--                </div>-->
<!--            </td>-->
<!--        `;-->

<!--        // lidh eventet pÃ«r total-->
<!--        newRow.querySelectorAll('input[name$=".quantity"], input[name$=".unitPrice"]').forEach(input => {-->
<!--            input.addEventListener('input', calculateTotal);-->
<!--        });-->

<!--        calculateTotal();-->
<!--    }-->

<!--    function deleteItemRow(button) {-->
<!--        const row = button.closest('tr');-->
<!--        if (!row) return;-->
<!--        row.remove();-->
<!--        calculateTotal();-->
<!--    }-->

<!--    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
<!--    // DYNAMIC SERVICES PER ITEM-->
<!--    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
<!--    function addServiceRow(itemButton) {-->
<!--        const itemRow = itemButton.closest('tr');-->
<!--        if (!itemRow) return;-->

<!--        const itemIndex = parseInt(itemRow.dataset.itemIndex || "0");-->
<!--        const servicesBody = itemRow.querySelector(`#servicesBody_${itemIndex}`);-->
<!--        if (!servicesBody) return;-->

<!--        serviceCounter++;-->

<!--        const newServiceRow = servicesBody.insertRow();-->

<!--        newServiceRow.innerHTML = `-->
<!--            <td>-->
<!--                <div id="serviceContainer_${serviceCounter}" class="searchable-select">-->
<!--                    <input type="text"-->
<!--                           class="select-input"-->
<!--                           placeholder="Zgjidh shÃ«rbimin..."-->
<!--                           readonly/>-->
<!--                    <div class="dropdown-menu"></div>-->
<!--                </div>-->
<!--                <input type="hidden" name="orderServices[${serviceCounter}].serviceId" value=""/>-->
<!--            </td>-->
<!--            <td>-->
<!--                <input type="number"-->
<!--                       name="orderServices[${serviceCounter}].quantity"-->
<!--                       class="form-control form-control-sm"-->
<!--                       min="1" value="1" required/>-->
<!--            </td>-->
<!--            <td>-->
<!--                <input type="number" step="0.01"-->
<!--                       name="orderServices[${serviceCounter}].price"-->
<!--                       class="form-control form-control-sm"-->
<!--                       min="0"-->
<!--                       placeholder="Auto-llogaritet"-->
<!--                       readonly/>-->
<!--            </td>-->
<!--            <td>-->
<!--                <button type="button"-->
<!--                        class="btn btn-danger btn-sm"-->
<!--                        onclick="deleteServiceRow(this)">Fshij</button>-->
<!--            </td>-->
<!--        `;-->

<!--        // hidden orderItemId (kÃ«tu po ruajmÃ« index-in e item-it)-->
<!--        const hiddenItemId = document.createElement('input');-->
<!--        hiddenItemId.type = 'hidden';-->
<!--        hiddenItemId.name = `orderServices[${serviceCounter}].orderItemId`;-->
<!--        hiddenItemId.value = itemIndex;-->
<!--        newServiceRow.appendChild(hiddenItemId);-->

<!--        // events pÃ«r total-->
<!--        newServiceRow.querySelectorAll('input[name$=".quantity"]').forEach(input => {-->
<!--            input.addEventListener('input', calculateTotal);-->
<!--        });-->

<!--        // inicializo search dropdown pÃ«r kÃ«tÃ« service-->
<!--        initSearchableSelectForServices(`serviceContainer_${serviceCounter}`, `orderServices[${serviceCounter}].serviceId`);-->

<!--        calculateTotal();-->
<!--    }-->

<!--    function deleteServiceRow(button) {-->
<!--        const row = button.closest('tr');-->
<!--        if (!row) return;-->
<!--        row.remove();-->
<!--        calculateTotal();-->
<!--    }-->

<!--    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
<!--    // TOTALI-->
<!--    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
<!--    function calculateTotal() {-->
<!--        let total = 0;-->

<!--        // items bazÃ«-->
<!--        document.querySelectorAll('#itemsTableBody tr').forEach(row => {-->
<!--            const qtyInput = row.querySelector('input[name$=".quantity"]');-->
<!--            const priceInput = row.querySelector('input[name$=".unitPrice"]');-->
<!--            if (qtyInput && priceInput) {-->
<!--                const qty = parseInt(qtyInput.value) || 0;-->
<!--                const price = parseFloat(priceInput.value) || 0;-->
<!--                total += qty * price;-->
<!--            }-->
<!--        });-->

<!--        // services-->
<!--        document.querySelectorAll('.services-subtable tbody tr').forEach(row => {-->
<!--            const qtyInput = row.querySelector('input[name$=".quantity"]');-->
<!--            const priceInput = row.querySelector('input[name$=".price"]');-->
<!--            if (qtyInput && priceInput) {-->
<!--                const qty = parseInt(qtyInput.value) || 0;-->
<!--                const price = parseFloat(priceInput.value) || 0;-->
<!--                total += qty * price;-->
<!--            }-->
<!--        });-->

<!--        const totalField = document.getElementById('totalAmount');-->
<!--        if (totalField) {-->
<!--            totalField.value = total.toFixed(2) + ' â‚¬';-->
<!--        }-->
<!--    }-->

<!--    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
<!--    // SEARCHABLE SELECT - SERVICES-->
<!--    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
<!--    function initSearchableSelectForServices(containerId, hiddenFieldName) {-->
<!--        const container = document.getElementById(containerId);-->
<!--        if (!container) return;-->

<!--        const input = container.querySelector('.select-input');-->
<!--        const dropdown = container.querySelector('.dropdown-menu');-->
<!--        if (!input || !dropdown) return;-->

<!--        const templateItems = Array.from(document.querySelectorAll('#serviceDropdownTemplate .dropdown-item'));-->
<!--        let items = templateItems.map(item => item.cloneNode(true));-->

<!--        function renderItems(list) {-->
<!--            dropdown.innerHTML = '';-->
<!--            if (!list || list.length === 0) {-->
<!--                dropdown.innerHTML = '<div class="no-results">AsnjÃ« shÃ«rbim nuk u gjet.</div>';-->
<!--                return;-->
<!--            }-->
<!--            list.forEach(i => dropdown.appendChild(i));-->
<!--        }-->

<!--        function filterItems(query) {-->
<!--            if (!query) {-->
<!--                renderItems(items.map(i => i.cloneNode(true)));-->
<!--            } else {-->
<!--                const filtered = items.filter(i =>-->
<!--                    i.textContent.toLowerCase().includes(query.toLowerCase())-->
<!--                );-->
<!--                renderItems(filtered.map(i => i.cloneNode(true)));-->
<!--            }-->
<!--        }-->

<!--        input.addEventListener('click', function (e) {-->
<!--            e.stopPropagation();-->
<!--            input.removeAttribute('readonly');-->
<!--            filterItems(input.value);-->
<!--            dropdown.classList.add('show');-->
<!--            input.focus();-->
<!--        });-->

<!--        input.addEventListener('input', function () {-->
<!--            filterItems(input.value);-->
<!--            dropdown.classList.add('show');-->
<!--        });-->

<!--        dropdown.addEventListener('click', function (e) {-->
<!--            const target = e.target.closest('.dropdown-item');-->
<!--            if (!target) return;-->

<!--            input.value = target.textContent.trim();-->

<!--            const hiddenInput = document.querySelector(`input[name="${hiddenFieldName}"]`);-->
<!--            if (hiddenInput) {-->
<!--                hiddenInput.value = target.dataset.value;-->
<!--            }-->

<!--            // vendos price automatik-->
<!--            const priceInput = container.closest('tr').querySelector('input[name$=".price"]');-->
<!--            if (priceInput && target.dataset.price) {-->
<!--                priceInput.value = target.dataset.price;-->
<!--            }-->

<!--            dropdown.classList.remove('show');-->
<!--            calculateTotal();-->
<!--        });-->

<!--        document.addEventListener('click', function (e) {-->
<!--            if (!container.contains(e.target)) {-->
<!--                dropdown.classList.remove('show');-->
<!--            }-->
<!--        });-->

<!--        dropdown.classList.remove('show');-->
<!--    }-->

<!--    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
<!--    // SEARCHABLE SELECT - KLIENTÃ‹T-->
<!--    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
<!--    function initSearchableSelectForCustomers() {-->
<!--        const container = document.getElementById('customerContainer');-->
<!--        if (!container) return;-->

<!--        const input = container.querySelector('.select-input');-->
<!--        const dropdown = container.querySelector('.dropdown-menu');-->
<!--        let items = Array.from(container.querySelectorAll('.dropdown-item'));-->

<!--        // hiq origjinalet nga DOM, ruaji nÃ« memorie-->
<!--        items.forEach(item => item.remove());-->

<!--        function renderItems(list) {-->
<!--            dropdown.innerHTML = '';-->
<!--            if (!list || list.length === 0) {-->
<!--                dropdown.innerHTML = '<div class="no-results">AsnjÃ« klient nuk u gjet.</div>';-->
<!--                return;-->
<!--            }-->
<!--            list.forEach(i => dropdown.appendChild(i));-->
<!--        }-->

<!--        function filterItems(query) {-->
<!--            if (!query) {-->
<!--                const unique = [...new Set(items.map(i => i.textContent.trim()))]-->
<!--                    .map(text => items.find(i => i.textContent.trim() === text).cloneNode(true));-->
<!--                renderItems(unique);-->
<!--            } else {-->
<!--                const filtered = items.filter(i =>-->
<!--                    i.textContent.toLowerCase().includes(query.toLowerCase())-->
<!--                );-->
<!--                const uniqueFiltered = [...new Set(filtered.map(i => i.textContent.trim()))]-->
<!--                    .map(text => filtered.find(i => i.textContent.trim() === text).cloneNode(true));-->
<!--                renderItems(uniqueFiltered);-->
<!--            }-->
<!--        }-->

<!--        input.addEventListener('click', function (e) {-->
<!--            e.stopPropagation();-->
<!--            input.removeAttribute('readonly');-->
<!--            filterItems(input.value);-->
<!--            dropdown.classList.add('show');-->
<!--            input.focus();-->
<!--        });-->

<!--        input.addEventListener('input', function () {-->
<!--            filterItems(input.value);-->
<!--            dropdown.classList.add('show');-->
<!--        });-->

<!--        dropdown.addEventListener('click', function (e) {-->
<!--            const target = e.target.closest('.dropdown-item');-->
<!--            if (!target) return;-->

<!--            input.value = target.textContent.trim();-->
<!--            const hiddenInput = document.querySelector('input[name="customerId"]');-->
<!--            if (hiddenInput) {-->
<!--                hiddenInput.value = target.dataset.value;-->
<!--            }-->
<!--            dropdown.classList.remove('show');-->
<!--        });-->

<!--        document.addEventListener('click', function (e) {-->
<!--            if (!container.contains(e.target)) {-->
<!--                dropdown.classList.remove('show');-->
<!--            }-->
<!--        });-->

<!--        dropdown.classList.remove('show');-->
<!--    }-->

<!--    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
<!--    // ON LOAD-->
<!--    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
<!--    document.addEventListener('DOMContentLoaded', function () {-->

<!--        // Inicializo totalet-->
<!--        calculateTotal();-->

<!--        // Lidh evente ekzistuese pÃ«r input-et-->
<!--        document.querySelectorAll('input[name$=".quantity"], input[name$=".unitPrice"], input[name$=".price"]')-->
<!--            .forEach(input => {-->
<!--                input.addEventListener('input', calculateTotal);-->
<!--            });-->

<!--        // KlientÃ«t searchable-->
<!--        initSearchableSelectForCustomers();-->

<!--        // Services ekzistuese nÃ«se ka (nga DTO pas error-it)-->
<!--        document.querySelectorAll('.services-subtable tbody tr .searchable-select')-->
<!--            .forEach((selectContainer, index) => {-->
<!--                if (!selectContainer.id) {-->
<!--                    selectContainer.id = `serviceContainer_${index}`;-->
<!--                }-->
<!--                initSearchableSelectForServices(selectContainer.id, `orderServices[${index}].serviceId`);-->
<!--            });-->
<!--    });-->
<!--</script>-->
<!--</body>-->
<!--</html>-->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Shto Porosi tÃ« Re</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <style>
        .searchable-select {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .searchable-select .select-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
        }
        .searchable-select .select-input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .searchable-select .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .searchable-select .dropdown-menu.show {
            display: block;
        }
        .searchable-select .dropdown-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .searchable-select .dropdown-item:hover {
            background-color: #f8f9fa;
        }
        .searchable-select .dropdown-item:last-child {
            border-bottom: none;
        }
        .searchable-select .no-results {
            padding: 10px;
            color: #999;
            font-style: italic;
        }

        .mb-3 .searchable-select {
            width: 100%;
        }

        .services-subtable {
            margin-top: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 10px;
        }
        .services-subtable table {
            font-size: 0.875rem;
        }
    </style>
</head>

<body>
<div class="container mt-4">
    <h1>Shto Porosi tÃ« Re</h1>

    <!-- Mesazhe error/success -->
    <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
    <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>

    <form th:action="@{/orders/add}" th:object="${orderCreateDTO}" method="post">

        <!-- ----------------- KLIENTI ----------------- -->
        <div class="mb-3">
            <label class="form-label">Klienti *</label>
            <div id="customerContainer" class="searchable-select">
                <input type="text" class="select-input"
                       placeholder="Shkruaj emrin e klientit..."
                       readonly/>
                <div class="dropdown-menu"></div>

                <!-- Lista e klientÃ«ve (origjinalet hiqen me JS, pÃ«rdoren si template) -->
                <div class="dropdown-item"
                     th:each="customer : ${customers}"
                     th:data-value="${customer.id}"
                     th:text="${customer.firstName} + ' ' + ${customer.lastName}">
                </div>
            </div>
            <input type="hidden" th:field="*{customerId}"/>
            <div th:if="${#fields.hasErrors('customerId')}" class="text-danger" th:errors="*{customerId}"></div>
            <small class="form-text text-muted">Kliko dhe shkruaj pÃ«r tÃ« kÃ«rkuar klientin nga lista.</small>
        </div>

        <!-- ----------------- DATAT DHE SHÃ‹NIMET ----------------- -->
        <div class="mb-3">
            <label class="form-label">Data e DorÃ«zimit *</label>
            <input type="date"
                   th:field="*{dropoffDate}"
                   class="form-control"
                   required
                   th:min="${#temporals.format(T(java.time.LocalDate).now(), 'yyyy-MM-dd')}"/>
            <div th:if="${#fields.hasErrors('dropoffDate')}" class="text-danger" th:errors="*{dropoffDate}"></div>
            <small class="form-text text-muted">Min: Sot ose mÃ« vonÃ«.</small>
        </div>

        <div class="mb-3">
            <label class="form-label">Data e Marrjes</label>
            <input type="date"
                   th:field="*{pickupDate}"
                   class="form-control"
                   th:min="${#temporals.format(T(java.time.LocalDate).now(), 'yyyy-MM-dd')}"/>
            <div th:if="${#fields.hasErrors('pickupDate')}" class="text-danger" th:errors="*{pickupDate}"></div>
        </div>

        <div class="mb-3">
            <label class="form-label">ShÃ«nime</label>
            <textarea th:field="*{notes}" class="form-control" rows="3"></textarea>
            <div th:if="${#fields.hasErrors('notes')}" class="text-danger" th:errors="*{notes}"></div>
        </div>

        <!-- Status (mund ta mbash hidden, backend e vendos RECEIVED prapÃ«) -->
        <input type="hidden" th:field="*{status}" value="RECEIVED"/>

        <!-- ----------------- ITEMS (RROBAT) ----------------- -->
        <h3>Artikujt e PorosisÃ« (Rrobat)</h3>
        <p>Shto artikujt qÃ« do tÃ« lahen. Subtotal-i dhe totali llogariten automatikisht.</p>

        <div class="mb-3">
            <button type="button" class="btn btn-success mb-2" onclick="addItemRow()">Shto Artikull</button>

            <table class="table table-bordered">
                <thead>
                <tr>
                    <th>PÃ«rshkrimi</th>
                    <th>Sasia</th>
                    <th>Ã‡mimi Unitar (â‚¬)</th>
                    <th>Veprime Item</th>
                    <th>ShÃ«rbimet pÃ«r kÃ«tÃ« Item</th>
                </tr>
                </thead>
                <tbody id="itemsTableBody">

                <!-- NÃ«se ka items nga DTO (p.sh. nga validation error) -->
                <tr th:each="item, iterStat : *{orderItems}"
                    th:attr="data-item-index=${iterStat.index}">
                    <td>
                        <input type="text"
                               th:field="*{orderItems[__${iterStat.index}__].itemDescription}"
                               class="form-control" required/>
                    </td>
                    <td>
                        <input type="number"
                               th:field="*{orderItems[__${iterStat.index}__].quantity}"
                               class="form-control" min="1" required/>
                    </td>
                    <td>
                        <input type="number" step="0.01"
                               th:field="*{orderItems[__${iterStat.index}__].unitPrice}"
                               class="form-control" min="0" required/>
                    </td>
                    <td>
                        <button type="button" class="btn btn-success btn-sm me-1" onclick="addServiceRow(this)">
                            Shto ShÃ«rbim
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteItemRow(this)">
                            Fshij Item
                        </button>
                    </td>
                    <td>
                        <div class="services-subtable">
                            <table class="table table-sm table-bordered">
                                <thead>
                                <tr>
                                    <th>ShÃ«rbim</th>
                                    <th>Sasia</th>
                                    <th>Ã‡mim (â‚¬)</th>
                                    <th>Veprime</th>
                                </tr>
                                </thead>
                                <tbody th:id="'servicesBody_' + ${iterStat.index}">

                                <!-- Services ekzistuese pÃ«r kÃ«tÃ« item -->
                                <tr th:each="oservice, sIter : *{orderServices}"
                                    th:if="${oservice.orderItemId} == ${iterStat.index}">
                                    <td>
                                        <div th:id="'serviceContainer_' + ${sIter.index}" class="searchable-select">
                                            <input type="text"
                                                   class="select-input"
                                                   th:value="${oservice.serviceName != null} ? ${oservice.serviceName} : ''"
                                                   placeholder="Zgjidh shÃ«rbimin..."
                                                   readonly/>
                                            <div class="dropdown-menu"></div>
                                        </div>

                                        <!-- serviceId -->
                                        <input type="hidden"
                                               th:name="'orderServices[' + ${sIter.index} + '].serviceId'"
                                               th:value="${oservice.serviceId}"/>

                                        <!-- orderItemId (kÃ«tu po ruajmÃ« index-in e item-it) -->
                                        <input type="hidden"
                                               th:name="'orderServices[' + ${sIter.index} + '].orderItemId'"
                                               th:value="${iterStat.index}"/>
                                    </td>
                                    <td>
                                        <input type="number"
                                               th:name="'orderServices[' + ${sIter.index} + '].quantity'"
                                               th:value="${oservice.quantity}"
                                               class="form-control form-control-sm"
                                               min="1" required/>
                                    </td>
                                    <td>
                                        <input type="number" step="0.01"
                                               th:name="'orderServices[' + ${sIter.index} + '].price'"
                                               th:value="${oservice.price}"
                                               class="form-control form-control-sm"
                                               min="0" readonly/>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-danger btn-sm"
                                                onclick="deleteServiceRow(this)">Fshij
                                        </button>
                                    </td>
                                </tr>

                                </tbody>
                            </table>
                        </div>
                    </td>
                </tr>

                <!-- NÃ«se nuk ka fare items nÃ« DTO, fus njÃ« rresht bosh default -->
                <tr th:if="${orderCreateDTO.orderItems == null or orderCreateDTO.orderItems.isEmpty()}"
                    data-item-index="0">
                    <td>
                        <input type="text"
                               name="orderItems[0].itemDescription"
                               class="form-control"
                               placeholder="P.sh., KÃ«mishÃ« e bardhÃ«"
                               required/>
                    </td>
                    <td>
                        <input type="number"
                               name="orderItems[0].quantity"
                               class="form-control"
                               min="1" value="1" required/>
                    </td>
                    <td>
                        <input type="number" step="0.01"
                               name="orderItems[0].unitPrice"
                               class="form-control"
                               min="0" placeholder="P.sh., 5.00" required/>
                    </td>
                    <td>
                        <button type="button" class="btn btn-success btn-sm me-1" onclick="addServiceRow(this)">
                            Shto ShÃ«rbim
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteItemRow(this)">
                            Fshij Item
                        </button>
                    </td>
                    <td>
                        <div class="services-subtable">
                            <table class="table table-sm table-bordered">
                                <thead>
                                <tr>
                                    <th>ShÃ«rbim</th>
                                    <th>Sasia</th>
                                    <th>Ã‡mim (â‚¬)</th>
                                    <th>Veprime</th>
                                </tr>
                                </thead>
                                <tbody id="servicesBody_0">
                                <!-- bosh fillimisht -->
                                </tbody>
                            </table>
                        </div>
                    </td>
                </tr>

                </tbody>
            </table>
        </div>

        <!-- ----------------- PAGESA ----------------- -->
        <div class="mb-3">
            <label class="form-label">MÃ«nyra e PagesÃ«s *</label>
            <select class="form-select" th:field="*{paymentMethod}" required>
                <option value="" disabled
                        th:selected="${orderCreateDTO.paymentMethod == null}">
                    Zgjidh mÃ«nyrÃ«n e pagesÃ«s
                </option>
                <option value="CASH">Cash</option>
                <option value="CARD">KartÃ«</option>
            </select>

            <div th:if="${#fields.hasErrors('paymentMethod')}"
                 class="text-danger"
                 th:errors="*{paymentMethod}">
            </div>
        </div>

        <!-- ----------------- TOTALI PARAPRAK ----------------- -->
        <div class="mb-3">
            <label class="form-label">Totali i ParaprirÃ« (â‚¬)</label>
            <input type="text" id="totalAmount" class="form-control" readonly value="0.00"/>
            <small class="form-text text-muted">
                Llogaritet automatikisht (items + services). Totali zyrtar llogaritet nÃ« backend.
            </small>
        </div>

        <button type="submit" class="btn btn-primary">Ruaj PorosinÃ«</button>
        <a th:href="@{/orders}" class="btn btn-secondary">Kthehu</a>
    </form>
</div>

<!-- Template i fshehur me tÃ« gjitha services nga DB (pÃ«rdoret nga JS pÃ«r Ã§do dropdown) -->
<div id="serviceDropdownTemplate" class="d-none">
    <div class="dropdown-item"
         th:each="service : ${services}"
         th:data-value="${service.id}"
         th:data-price="${service.pricePerUnit}"
         th:text="${service.name} + ' (' + ${service.pricePerUnit} + ' â‚¬)'">
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    // ----------------------------------------------------------------
    // COUNTERS
    // ----------------------------------------------------------------
    let itemCounter = /*[[${initialItemCount}]]*/ 0;
    let serviceCounter = /*[[${initialServiceCount}]]*/ 0;

    // ----------------------------------------------------------------
    // DYNAMIC ITEMS
    // ----------------------------------------------------------------
    function addItemRow() {
        const tableBody = document.getElementById('itemsTableBody');
        const existingRows = tableBody.querySelectorAll('tr');
        // index i ri pÃ«r item-in
        itemCounter = existingRows.length > 0
            ? Math.max(...Array.from(existingRows).map(r => parseInt(r.dataset.itemIndex || "0"))) + 1
            : 0;

        const newRow = tableBody.insertRow();
        newRow.setAttribute('data-item-index', itemCounter);

        newRow.innerHTML = `
            <td>
                <input type="text"
                       name="orderItems[${itemCounter}].itemDescription"
                       class="form-control"
                       placeholder="P.sh., KÃ«mishÃ« e bardhÃ«"
                       required/>
            </td>
            <td>
                <input type="number"
                       name="orderItems[${itemCounter}].quantity"
                       class="form-control"
                       min="1" value="1" required/>
            </td>
            <td>
                <input type="number" step="0.01"
                       name="orderItems[${itemCounter}].unitPrice"
                       class="form-control"
                       min="0" placeholder="P.sh., 5.00"
                       required/>
            </td>
            <td>
                <button type="button" class="btn btn-success btn-sm me-1" onclick="addServiceRow(this)">
                    Shto ShÃ«rbim
                </button>
                <button type="button" class="btn btn-danger btn-sm" onclick="deleteItemRow(this)">
                    Fshij Item
                </button>
            </td>
            <td>
                <div class="services-subtable">
                    <table class="table table-sm table-bordered">
                        <thead>
                        <tr>
                            <th>ShÃ«rbim</th>
                            <th>Sasia</th>
                            <th>Ã‡mim (â‚¬)</th>
                            <th>Veprime</th>
                        </tr>
                        </thead>
                        <tbody id="servicesBody_${itemCounter}">
                        </tbody>
                    </table>
                </div>
            </td>
        `;

        // lidh eventet pÃ«r total
        newRow.querySelectorAll('input[name$=".quantity"], input[name$=".unitPrice"]').forEach(input => {
            input.addEventListener('input', calculateTotal);
        });

        calculateTotal();
    }

    function deleteItemRow(button) {
        const row = button.closest('tr');
        if (!row) return;
        row.remove();
        calculateTotal();
    }

    // ----------------------------------------------------------------
    // DYNAMIC SERVICES PER ITEM
    // ----------------------------------------------------------------
    function addServiceRow(itemButton) {
        const itemRow = itemButton.closest('tr');
        if (!itemRow) return;

        const itemIndex = parseInt(itemRow.dataset.itemIndex || "0");
        const servicesBody = itemRow.querySelector(`#servicesBody_${itemIndex}`);
        if (!servicesBody) return;

        serviceCounter++;

        const newServiceRow = servicesBody.insertRow();

        newServiceRow.innerHTML = `
            <td>
                <div id="serviceContainer_${serviceCounter}" class="searchable-select">
                    <input type="text"
                           class="select-input"
                           placeholder="Zgjidh shÃ«rbimin..."
                           readonly/>
                    <div class="dropdown-menu"></div>
                </div>
                <input type="hidden" name="orderServices[${serviceCounter}].serviceId" value=""/>
            </td>
            <td>
                <input type="number"
                       name="orderServices[${serviceCounter}].quantity"
                       class="form-control form-control-sm"
                       min="1" value="1" required/>
            </td>
            <td>
                <input type="number" step="0.01"
                       name="orderServices[${serviceCounter}].price"
                       class="form-control form-control-sm"
                       min="0"
                       placeholder="Auto-llogaritet"
                       readonly/>
            </td>
            <td>
                <button type="button"
                        class="btn btn-danger btn-sm"
                        onclick="deleteServiceRow(this)">Fshij</button>
            </td>
        `;

        // hidden orderItemId (kÃ«tu po ruajmÃ« index-in e item-it)
        const hiddenItemId = document.createElement('input');
        hiddenItemId.type = 'hidden';
        hiddenItemId.name = `orderServices[${serviceCounter}].orderItemId`;
        hiddenItemId.value = itemIndex;
        newServiceRow.appendChild(hiddenItemId);

        // events pÃ«r total
        newServiceRow.querySelectorAll('input[name$=".quantity"]').forEach(input => {
            input.addEventListener('input', calculateTotal);
        });

        // inicializo search dropdown pÃ«r kÃ«tÃ« service
        initSearchableSelectForServices(`serviceContainer_${serviceCounter}`, `orderServices[${serviceCounter}].serviceId`);

        calculateTotal();
    }

    function deleteServiceRow(button) {
        const row = button.closest('tr');
        if (!row) return;
        row.remove();
        calculateTotal();
    }

    // ----------------------------------------------------------------
    // TOTALI
    // ----------------------------------------------------------------
    function calculateTotal() {
        let total = 0;

        // items bazÃ«
        document.querySelectorAll('#itemsTableBody tr').forEach(row => {
            const qtyInput = row.querySelector('input[name$=".quantity"]');
            const priceInput = row.querySelector('input[name$=".unitPrice"]');
            if (qtyInput && priceInput) {
                const qty = parseInt(qtyInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                total += qty * price;
            }
        });

        // services
        document.querySelectorAll('.services-subtable tbody tr').forEach(row => {
            const qtyInput = row.querySelector('input[name$=".quantity"]');
            const priceInput = row.querySelector('input[name$=".price"]');
            if (qtyInput && priceInput) {
                const qty = parseInt(qtyInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                total += qty * price;
            }
        });

        const totalField = document.getElementById('totalAmount');
        if (totalField) {
            totalField.value = total.toFixed(2) + ' â‚¬';
        }
    }

    // ----------------------------------------------------------------
    // SEARCHABLE SELECT - SERVICES
    // ----------------------------------------------------------------
    function initSearchableSelectForServices(containerId, hiddenFieldName) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const input = container.querySelector('.select-input');
        const dropdown = container.querySelector('.dropdown-menu');
        if (!input || !dropdown) return;

        const templateItems = Array.from(document.querySelectorAll('#serviceDropdownTemplate .dropdown-item'));
        let items = templateItems.map(item => item.cloneNode(true));

        function renderItems(list) {
            dropdown.innerHTML = '';
            if (!list || list.length === 0) {
                dropdown.innerHTML = '<div class="no-results">AsnjÃ« shÃ«rbim nuk u gjet.</div>';
                return;
            }
            list.forEach(i => dropdown.appendChild(i));
        }

        function filterItems(query) {
            if (!query) {
                renderItems(items.map(i => i.cloneNode(true)));
            } else {
                const filtered = items.filter(i =>
                    i.textContent.toLowerCase().includes(query.toLowerCase())
                );
                renderItems(filtered.map(i => i.cloneNode(true)));
            }
        }

        input.addEventListener('click', function (e) {
            e.stopPropagation();
            input.removeAttribute('readonly');
            filterItems(input.value);
            dropdown.classList.add('show');
            input.focus();
        });

        input.addEventListener('input', function () {
            filterItems(input.value);
            dropdown.classList.add('show');
        });

        dropdown.addEventListener('click', function (e) {
            const target = e.target.closest('.dropdown-item');
            if (!target) return;

            input.value = target.textContent.trim();

            const hiddenInput = document.querySelector(`input[name="${hiddenFieldName}"]`);
            if (hiddenInput) {
                hiddenInput.value = target.dataset.value;
            }

            // vendos price automatik
            const priceInput = container.closest('tr').querySelector('input[name$=".price"]');
            if (priceInput && target.dataset.price) {
                priceInput.value = target.dataset.price;
            }

            dropdown.classList.remove('show');
            calculateTotal();
        });

        document.addEventListener('click', function (e) {
            if (!container.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        dropdown.classList.remove('show');
    }

    // ----------------------------------------------------------------
    // SEARCHABLE SELECT - KLIENTÃ‹T
    // ----------------------------------------------------------------
    function initSearchableSelectForCustomers() {
        const container = document.getElementById('customerContainer');
        if (!container) return;

        const input = container.querySelector('.select-input');
        const dropdown = container.querySelector('.dropdown-menu');
        let items = Array.from(container.querySelectorAll('.dropdown-item'));

        // hiq origjinalet nga DOM, ruaji nÃ« memorie
        items.forEach(item => item.remove());

        function renderItems(list) {
            dropdown.innerHTML = '';
            if (!list || list.length === 0) {
                dropdown.innerHTML = '<div class="no-results">AsnjÃ« klient nuk u gjet.</div>';
                return;
            }
            list.forEach(i => dropdown.appendChild(i));
        }

        function filterItems(query) {
            if (!query) {
                const unique = [...new Set(items.map(i => i.textContent.trim()))]
                    .map(text => items.find(i => i.textContent.trim() === text).cloneNode(true));
                renderItems(unique);
            } else {
                const filtered = items.filter(i =>
                    i.textContent.toLowerCase().includes(query.toLowerCase())
                );
                const uniqueFiltered = [...new Set(filtered.map(i => i.textContent.trim()))]
                    .map(text => filtered.find(i => i.textContent.trim() === text).cloneNode(true));
                renderItems(uniqueFiltered);
            }
        }

        input.addEventListener('click', function (e) {
            e.stopPropagation();
            input.removeAttribute('readonly');
            filterItems(input.value);
            dropdown.classList.add('show');
            input.focus();
        });

        input.addEventListener('input', function () {
            filterItems(input.value);
            dropdown.classList.add('show');
        });

        dropdown.addEventListener('click', function (e) {
            const target = e.target.closest('.dropdown-item');
            if (!target) return;

            input.value = target.textContent.trim();
            const hiddenInput = document.querySelector('input[name="customerId"]');
            if (hiddenInput) {
                hiddenInput.value = target.dataset.value;
            }
            dropdown.classList.remove('show');
        });

        document.addEventListener('click', function (e) {
            if (!container.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        dropdown.classList.remove('show');
    }

    // ----------------------------------------------------------------
    // ON LOAD
    // ----------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', function () {

        // Inicializo totalet
        calculateTotal();

        // Lidh evente ekzistuese pÃ«r input-et
        document.querySelectorAll('input[name$=".quantity"], input[name$=".unitPrice"], input[name$=".price"]')
            .forEach(input => {
                input.addEventListener('input', calculateTotal);
            });

        // KlientÃ«t searchable
        initSearchableSelectForCustomers();

        // Services ekzistuese nÃ«se ka (nga DTO pas error-it)
        document.querySelectorAll('.services-subtable tbody tr .searchable-select')
            .forEach((selectContainer, index) => {
                if (!selectContainer.id) {
                    selectContainer.id = `serviceContainer_${index}`;
                }
                initSearchableSelectForServices(selectContainer.id, `orderServices[${index}].serviceId`);
            });
    });
</script>
</body>
</html>

